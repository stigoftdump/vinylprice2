<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinyl Price Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
</head>

<body>

    <div class="main-container">
        <header>
            <div class="header-top-row">
                <img src="{{ url_for('static', filename='images/oxfam-logo.png') }}" alt="Oxfam Logo" class="header-logo">
                <div class="header-title-container">
                    <h1>Vinyl Price Calculator</h1>
                </div>
                <div class="header-spacer"></div>
            </div>
            </header>

        <div class="content-wrapper">
            <div class="left-column">
                <form method="POST">
                    <div class="paste-container">
                        <label for="pasted_discogs_data" class="paste-label label-with-tooltip">
                            <span>Paste Discogs Sales Data:</span>
                            <div class="tooltip-container">
                                <img src="{{ url_for('static', filename='images/info.svg') }}" alt="Info">
                                <span class="tooltip-text">Paste copied sales history from Discogs here.</span>
                            </div>
                        </label>
                        <textarea id="pasted_discogs_data" name="pasted_discogs_data" placeholder="Paste data here...">{{ pasted_discogs_data }}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="media" class="label-with-tooltip">
                            <span>Media Condition:</span>
                             <div class="tooltip-container">
                                <img src="{{ url_for('static', filename='images/info.svg') }}" alt="Info">
                                <span class="tooltip-text">Select the grading for the vinyl/media itself.</span>
                            </div>
                        </label>
                        <select id="media" name="media">
                            <option value="9" {% if media == 9 %}selected{% endif %}>Mint (M)</option>
                            <option value="8" {% if media == 8 %}selected{% endif %}>Near Mint (NM or M-)</option>
                            <option value="7" {% if media == 7 %}selected{% endif %}>Very Good Plus (VG+)</option>
                            <option value="6" {% if media == 6 %}selected{% endif %}>Very Good (VG)</option>
                            <option value="5" {% if media == 5 %}selected{% endif %}>Good Plus (G+)</option>
                            <option value="4" {% if media == 4 %}selected{% endif %}>Good (G)</option>
                            <option value="3" {% if media == 3 %}selected{% endif %}>Fair (F)</option>
                            <option value="2" {% if media == 2 %}selected{% endif %}>Poor (P)</option>
                            <option value="1" {% if media == 1 %}selected{% endif %}>Generic / Not Graded / No Cover</option>
                        </select>
                    </div>

                    <div class="form-group">
                         <label for="sleeve" class="label-with-tooltip">
                            <span>Sleeve Condition:</span>
                             <div class="tooltip-container">
                                <img src="{{ url_for('static', filename='images/info.svg') }}" alt="Info">
                                <span class="tooltip-text">Select the grading for the record sleeve/cover.</span>
                            </div>
                        </label>
                        <select id="sleeve" name="sleeve">
                            <option value="9" {% if sleeve == 9 %}selected{% endif %}>Mint (M)</option>
                            <option value="8" {% if sleeve == 8 %}selected{% endif %}>Near Mint (NM or M-)</option>
                            <option value="7" {% if sleeve == 7 %}selected{% endif %}>Very Good Plus (VG+)</option>
                            <option value="6" {% if media == 6 %}selected{% endif %}>Very Good (VG)</option>
                            <option value="5" {% if media == 5 %}selected{% endif %}>Good Plus (G+)</option>
                            <option value="4" {% if media == 4 %}selected{% endif %}>Good (G)</option>
                            <option value="3" {% if media == 3 %}selected{% endif %}>Fair (F)</option>
                            <option value="2" {% if media == 2 %}selected{% endif %}>Poor (P)</option>
                            <option value="1" {% if media == 1 %}selected{% endif %}>Generic / Not Graded / No Cover</option>
                        </select>
                    </div>

                    <div class="form-group">
                         <label for="shop_var" class="label-with-tooltip">
                           <span>Shop Variance Factor:</span>
                             <div class="tooltip-container">
                                <img src="{{ url_for('static', filename='images/info.svg') }}" alt="Info">
                                <span class="tooltip-text">Adjusts the final price based on uncertainty (0.1-2.0). Lower=closer to prediction, Higher=closer to upper bound.</span>
                            </div>
                        </label>
                        <input type="number" id="shop_var" name="shop_var" value="{{ shop_var }}" step="0.1" min="0.1" max="2">
                    </div>

                    <div class="form-group date-add-group">
                         <div class="date-group">
                             <label for="start_date" class="label-with-tooltip">
                               <span>Include Sales From:</span>
                                 <div class="tooltip-container">
                                    <img src="{{ url_for('static', filename='images/info.svg') }}" alt="Info">
                                    <span class="tooltip-text">Only include sales data from this date onwards.</span>
                                </div>
                            </label>
                            <input type="date" id="start_date" name="start_Date" value="{{ start_date }}">
                         </div>
                         <div class="add-data-group">
                            <input type="checkbox" id="add_data" name="add_data" {% if add_data %}checked{% endif %}>
                             <label for="add_data" class="label-with-tooltip">
                                <span>Add to Previous Data</span>
                                <div class="tooltip-container">
                                    <img src="{{ url_for('static', filename='images/info.svg') }}" alt="Info">
                                    <span class="tooltip-text">Check this to merge the pasted data with data from the last calculation. Uncheck to replace.</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <input type="hidden" id="selected_points_to_delete" name="selected_points_to_delete">

                    <div class="button-container">
                        <button type="submit" name="action" value="calculate">Estimate Price</button>
                    </div>

                </form>
            </div>
            <div class="right-column">
                 {% if calculated_price is not none or status_message and ('Error' in status_message or 'Missing' in status_message or 'failed' in status_message) %} {# Updated condition to show results area also on errors conveyed by status_message #}
                 <div class="results-container">
                     <h2>Estimation Results:</h2>
                     {# Check for errors specifically for the price calculation part first #}
                     {% if calculated_price == 'Error' %}
                        <p class="price-error"><strong>Calculation Error:</strong> {{ status_message }}</p>
                     {# Then check if there's a general error status_message and no specific calculated_price #}
                     {% elif status_message and ('Error' in status_message or 'Missing' in status_message or 'failed' in status_message) and calculated_price is none %}
                        <p class="price-error"><strong>Status:</strong> {{ status_message }}</p>
                     {% elif calculated_price is not none %}
                        <p class="price-calculated"><strong>Predicted Price:</strong> £{{ calculated_price }}</p>
                        <p class="price-upper-bound"><strong>Max Price:</strong> £{{ adjusted_price }}</p>
                        <p class="price-actual"><strong>Suggested Price:</strong> £{{ actual_price }}</p>
                     {% endif %}
                 </div>
                 {% endif %}

                {% if chart_data %}
                   <div class="chart-container">
                       <canvas id="myChart"></canvas>
                   </div>
                   <script id="chart-data-json" type="application/json">
                       {{ chart_data | tojson | safe }}
                   </script>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    {% if status_message %}
    <div id="initial-status-data"
         data-message="{{ status_message }}"
         data-message-type="{% if 'Error' in status_message or 'failed' in status_message or 'Missing' in status_message %}error{% elif 'Completed' in status_message or 'calculated' in status_message or 'success' in status_message %}success{% else %}info{% endif %}"
         style="display: none;">
    </div>
    {% endif %}

    {% if chart_data %}
    <script>
        // --- Chart.js Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('myChart').getContext('2d');
            const jsonScriptTag = document.getElementById('chart-data-json');
            const jsonString = jsonScriptTag.textContent;
            const chartData = JSON.parse(jsonString);

            const labels = chartData.labels;
            const prices = chartData.prices;
            const predictedPrices = chartData.predicted_prices;
            const predictedQualities = chartData.predicted_qualities;
            const reqscore = parseFloat(chartData.reqscore);
            const predictedPrice = chartData.predicted_price;
            const upperBound = chartData.upper_bound;
            const actualPrice = chartData.actual_price;
            const dates = chartData.dates;
            const comments = chartData.comments;

            const all_qualities = labels.map(parseFloat).concat(predictedQualities.map(parseFloat));
            const minQualityInData = all_qualities.length > 0 ? Math.min(...all_qualities) : 1;
            const maxQualityInData = all_qualities.length > 0 ? Math.max(...all_qualities) : 9;
            const xAxisMin = Math.floor(Math.min(minQualityInData, reqscore));
            const xAxisMax = Math.ceil(Math.max(maxQualityInData, reqscore));

            let selectedPoints = [];

            function doPointsMatch(point1, point2) {
                const tolerance = 0.0001;
                return (
                    Math.abs(point1.quality - point2.quality) < tolerance &&
                    Math.abs(point1.price - point2.price) < tolerance &&
                    point1.date === point2.date &&
                    (point1.comment || "") === (point2.comment || "")
                );
            }

            function handlePointClick(event, elements, chart) {
                if (elements.length > 0) {
                    const clickedElement = elements[0];
                    const datasetIndex = clickedElement.datasetIndex;
                    const dataIndex = clickedElement.index;

                    if (datasetIndex === 0) { // Assuming actual data points are the first dataset
                        const clickedPointData = {
                            quality: parseFloat(labels[dataIndex]),
                            price: prices[dataIndex],
                            date: dates[dataIndex],
                            comment: comments[dataIndex]
                        };

                        const selectedIndex = selectedPoints.findIndex(p => doPointsMatch(p, clickedPointData));
                        const backgroundColors = chart.data.datasets[datasetIndex].backgroundColor;

                        if (selectedIndex > -1) {
                            selectedPoints.splice(selectedIndex, 1);
                            if (Array.isArray(backgroundColors)) {
                                backgroundColors[dataIndex] = 'red'; // Deselect color
                            }
                        } else {
                            selectedPoints.push(clickedPointData);
                             if (Array.isArray(backgroundColors)) {
                                backgroundColors[dataIndex] = 'black'; // Select color
                            }
                        }
                        chart.update();
                    }
                }
            }

            function wrapText(text, maxLength) {
                if (!text) return [];
                const words = text.split(' ');
                let lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length > maxLength) {
                        if (currentLine.length > 0) lines.push(currentLine.trim());
                        currentLine = word + ' ';
                    } else {
                        currentLine += word + ' ';
                    }
                });
                if (currentLine.length > 0) lines.push(currentLine.trim());
                return lines;
            }

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 1.5,
                onClick: handlePointClick,
                plugins: {
                    title: { display: true, text: 'Price Calculation', font: { size: 16, weight: '500' }, padding: { top: 10, bottom: 20 } },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            generateLabels: function(chart) { /* ... your existing legend generation ... */ }
                        }
                    },
                    tooltip: { /* ... your existing tooltip config ... */ },
                    annotation: { /* ... your existing annotation config ... */ }
                },
                scales: { /* ... your existing scales config ... */ }
            };

            const myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    labels: labels,
                    datasets: [{
                            label: 'Items Sold',
                            data: labels.map((label, index) => ({ x: parseFloat(label), y: prices[index] })),
                            borderColor: 'rgba(255, 0, 0, 0.3)',
                            backgroundColor: Array(prices.length).fill('red'), // Default color
                            pointRadius: 5,
                            pointHoverRadius: 7,
                        },
                        {
                            label: 'Best Fit Curve',
                            data: predictedQualities.map((qual, index) => ({ x: parseFloat(qual), y: predictedPrices[index] })),
                            borderColor: 'blue',
                            borderWidth: 2.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.3,
                            type: 'line',
                            showLine: true
                        }
                    ]
                },
                options: chartOptions
            });

            const form = document.querySelector('form');
            form.addEventListener('submit', function(event) {
                console.log("Submitting form. Discogs data will come from 'pasted_discogs_data' textarea.");
                const selectedPointsInput = document.getElementById('selected_points_to_delete');
                if (selectedPointsInput && typeof selectedPoints !== 'undefined') {
                    selectedPointsInput.value = JSON.stringify(selectedPoints);
                } else {
                    console.warn("selectedPoints variable not found or input missing.");
                    if (selectedPointsInput) selectedPointsInput.value = '[]';
                }
            });
        });
    </script>
    {% endif %}

    <script>
        // --- Toast Notification Logic ---
        function showToast(message, type = 'info', duration = 7000) { // Default duration 7 seconds
            const container = document.getElementById('toast-container');
            if (!container) {
                console.error('Toast container #toast-container not found!');
                return;
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`; // e.g., toast info, toast error

            const messageElement = document.createElement('span');
            messageElement.className = 'toast-message';
            messageElement.textContent = message;
            toast.appendChild(messageElement);

            const closeButton = document.createElement('button');
            closeButton.className = 'toast-close-button';
            closeButton.innerHTML = '&times;'; // HTML entity for '×'
            closeButton.setAttribute('aria-label', 'Close notification');
            closeButton.onclick = function() {
                toast.classList.remove('show');
                // Remove the toast from DOM after transition
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400); // Should match CSS transition duration for opacity/transform
            };
            toast.appendChild(closeButton);

            container.appendChild(toast);

            // Trigger the show animation
            // Requesting an animation frame ensures the element is in the DOM and ready for transition
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Auto-dismiss
            if (duration > 0) {
                setTimeout(() => {
                    // Check if toast still exists and is shown before trying to close
                    if (toast.parentNode && toast.classList.contains('show')) {
                        closeButton.click();
                    }
                }, duration);
            }
        }

        // Logic to show toast based on server-rendered status_message
        document.addEventListener('DOMContentLoaded', function() {
            const initialMessageDiv = document.getElementById('initial-status-data');
            if (initialMessageDiv) {
                const message = initialMessageDiv.getAttribute('data-message');
                const messageType = initialMessageDiv.getAttribute('data-message-type');
                if (message) {
                    showToast(message, messageType);
                }
            }

            // --- Form Submission Logic (keep existing) ---
            let formSubmitted = false;
            const mainForm = document.querySelector('form'); // Query specific form
            if (mainForm) {
                mainForm.addEventListener('submit', function() {
                    formSubmitted = true;
                });
            }

            window.addEventListener('beforeunload', function (e) {
                if (!formSubmitted) {
                    // Consider if navigator.sendBeacon('/shutdown', '') is still needed
                    // or if there are unsaved changes to warn about.
                    // For now, keeping it as is.
                    navigator.sendBeacon('/shutdown', '');
                }
            });
        });
    </script>

</body>
</html>